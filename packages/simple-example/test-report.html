<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
    </head>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
        }
        #donut-svg,
        #error-svg {
            overflow: visible;
        }
        #main-title,
        #bar-title {
            text-align: center;
        }
        html {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
                sans-serif;
        }
        #summary-donut,
        #error-bar-chart {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #donut-label,
        #error-caption {
            font-weight: bolder;
            text-align: center;
        }

        #error-bar-chart rect.background {
            fill: white;
        }

        #error-bar-chart .axis {
            shape-rendering: crispEdges;
        }

        #error-bar-chart .axis path,
        #error-bar-chart .axis line {
            fill: none;
            stroke: #000;
        }
    </style>
    <body>
        <h1 id="main-title">Nirikshak test summary</h1>
        <div id="summary-donut">
            <p id="donut-label"></p>
        </div>
        <h1 id="bar-title">Error distribution with attributes</h1>
        <div id="error-bar-chart">
            <p id="error-caption">
                Click on a blue bar to expand. Click on the background to go
                back.
            </p>
        </div>
        <br />
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
        <script>
            var data = JSON.parse(`{"total":10916,"passed":7632,"failed":3284,"parsedAssertions":[{"name":"resource","children":[{"name":"student","children":[{"name":"iteration","children":[{"name":"1 ","value":1642},{"name":"2 ","value":1642}]},{"name":"case","children":[{"name":"POSITIVE","value":1824},{"name":"NEGATIVE","value":1356},{"name":"DESTRUCTIVE","value":104}]},{"name":"url","children":[{"name":"/Student/{resource:id}/v1","value":360},{"name":"/Student/{resource:id}","value":1886},{"name":"/Student","value":706},{"name":"/Student/{resource:id}/v4","value":332}]},{"name":"error-message","children":[{"name":"Status mismatch: Expected 200,500 got 201","value":360},{"name":"Response bodies did not match","value":1146},{"name":"Status mismatch: Expected 409,200,201,202,210 got 400","value":360},{"name":"Status mismatch: Expected 400 got 500","value":104},{"name":"Status mismatch: Expected 404 got 400","value":332},{"name":"Status mismatch: Expected 404,409 got 500","value":332},{"name":"Status mismatch: Expected 201 got 200","value":318},{"name":"Status mismatch: Expected 404 got 200","value":332}]},{"name":"method","children":[{"name":"GET-1","value":360},{"name":"DELETE-0","value":376},{"name":"POST-0","value":706},{"name":"PATCH-0","value":380},{"name":"PUT-1","value":452},{"name":"GET-0","value":332},{"name":"DELETE-1","value":332},{"name":"POST-1","value":346}]}]}]},{"name":"iteration","children":[{"name":"1 ","children":[{"name":"resource","children":[{"name":"student","value":1642}]},{"name":"case","children":[{"name":"POSITIVE","value":912},{"name":"NEGATIVE","value":678},{"name":"DESTRUCTIVE","value":52}]},{"name":"url","children":[{"name":"/Student/{resource:id}/v1","value":180},{"name":"/Student/{resource:id}","value":943},{"name":"/Student","value":353},{"name":"/Student/{resource:id}/v4","value":166}]},{"name":"error-message","children":[{"name":"Status mismatch: Expected 200,500 got 201","value":180},{"name":"Response bodies did not match","value":573},{"name":"Status mismatch: Expected 409,200,201,202,210 got 400","value":180},{"name":"Status mismatch: Expected 400 got 500","value":52},{"name":"Status mismatch: Expected 404 got 400","value":166},{"name":"Status mismatch: Expected 404,409 got 500","value":166},{"name":"Status mismatch: Expected 201 got 200","value":159},{"name":"Status mismatch: Expected 404 got 200","value":166}]},{"name":"method","children":[{"name":"GET-1","value":180},{"name":"DELETE-0","value":188},{"name":"POST-0","value":353},{"name":"PATCH-0","value":190},{"name":"PUT-1","value":226},{"name":"GET-0","value":166},{"name":"DELETE-1","value":166},{"name":"POST-1","value":173}]}]},{"name":"2 ","children":[{"name":"resource","children":[{"name":"student","value":1642}]},{"name":"case","children":[{"name":"POSITIVE","value":912},{"name":"NEGATIVE","value":678},{"name":"DESTRUCTIVE","value":52}]},{"name":"url","children":[{"name":"/Student/{resource:id}/v1","value":180},{"name":"/Student/{resource:id}","value":943},{"name":"/Student","value":353},{"name":"/Student/{resource:id}/v4","value":166}]},{"name":"error-message","children":[{"name":"Status mismatch: Expected 200,500 got 201","value":180},{"name":"Response bodies did not match","value":573},{"name":"Status mismatch: Expected 409,200,201,202,210 got 400","value":180},{"name":"Status mismatch: Expected 400 got 500","value":52},{"name":"Status mismatch: Expected 404 got 400","value":166},{"name":"Status mismatch: Expected 404,409 got 500","value":166},{"name":"Status mismatch: Expected 201 got 200","value":159},{"name":"Status mismatch: Expected 404 got 200","value":166}]},{"name":"method","children":[{"name":"GET-1","value":180},{"name":"DELETE-0","value":188},{"name":"POST-0","value":353},{"name":"PATCH-0","value":190},{"name":"PUT-1","value":226},{"name":"GET-0","value":166},{"name":"DELETE-1","value":166},{"name":"POST-1","value":173}]}]}]},{"name":"case","children":[{"name":"POSITIVE","children":[{"name":"resource","children":[{"name":"student","value":1824}]},{"name":"iteration","children":[{"name":"1 ","value":912},{"name":"2 ","value":912}]},{"name":"url","children":[{"name":"/Student/{resource:id}/v1","value":360},{"name":"/Student/{resource:id}","value":1146},{"name":"/Student","value":318}]},{"name":"error-message","children":[{"name":"Status mismatch: Expected 200,500 got 201","value":360},{"name":"Response bodies did not match","value":1146},{"name":"Status mismatch: Expected 201 got 200","value":318}]},{"name":"method","children":[{"name":"GET-1","value":360},{"name":"DELETE-0","value":376},{"name":"PUT-1","value":452},{"name":"POST-0","value":318},{"name":"POST-1","value":318}]}]},{"name":"NEGATIVE","children":[{"name":"resource","children":[{"name":"student","value":1356}]},{"name":"iteration","children":[{"name":"1 ","value":678},{"name":"2 ","value":678}]},{"name":"url","children":[{"name":"/Student","value":360},{"name":"/Student/{resource:id}","value":664},{"name":"/Student/{resource:id}/v4","value":332}]},{"name":"error-message","children":[{"name":"Status mismatch: Expected 409,200,201,202,210 got 400","value":360},{"name":"Status mismatch: Expected 404 got 400","value":332},{"name":"Status mismatch: Expected 404,409 got 500","value":332},{"name":"Status mismatch: Expected 404 got 200","value":332}]},{"name":"method","children":[{"name":"POST-0","value":360},{"name":"GET-0","value":332},{"name":"DELETE-1","value":332},{"name":"PATCH-0","value":332}]}]},{"name":"DESTRUCTIVE","children":[{"name":"resource","children":[{"name":"student","value":104}]},{"name":"iteration","children":[{"name":"1 ","value":52},{"name":"2 ","value":52}]},{"name":"url","children":[{"name":"/Student/{resource:id}","value":76},{"name":"/Student","value":28}]},{"name":"error-message","children":[{"name":"Status mismatch: Expected 400 got 500","value":104}]},{"name":"method","children":[{"name":"PATCH-0","value":48},{"name":"POST-0","value":28},{"name":"POST-1","value":28}]}]}]},{"name":"url","children":[{"name":"/Student/{resource:id}/v1","children":[{"name":"resource","children":[{"name":"student","value":360}]},{"name":"iteration","children":[{"name":"1 ","value":180},{"name":"2 ","value":180}]},{"name":"case","children":[{"name":"POSITIVE","value":360}]},{"name":"error-message","children":[{"name":"Status mismatch: Expected 200,500 got 201","value":360}]},{"name":"method","children":[{"name":"GET-1","value":360}]}]},{"name":"/Student/{resource:id}","children":[{"name":"resource","children":[{"name":"student","value":1886}]},{"name":"iteration","children":[{"name":"1 ","value":943},{"name":"2 ","value":943}]},{"name":"case","children":[{"name":"POSITIVE","value":1146},{"name":"DESTRUCTIVE","value":76},{"name":"NEGATIVE","value":664}]},{"name":"error-message","children":[{"name":"Response bodies did not match","value":828},{"name":"Status mismatch: Expected 400 got 500","value":76},{"name":"Status mismatch: Expected 404 got 400","value":332},{"name":"Status mismatch: Expected 201 got 200","value":318},{"name":"Status mismatch: Expected 404 got 200","value":332}]},{"name":"method","children":[{"name":"DELETE-0","value":376},{"name":"PATCH-0","value":380},{"name":"PUT-1","value":452},{"name":"GET-0","value":332},{"name":"POST-1","value":346}]}]},{"name":"/Student","children":[{"name":"resource","children":[{"name":"student","value":706}]},{"name":"iteration","children":[{"name":"1 ","value":353},{"name":"2 ","value":353}]},{"name":"case","children":[{"name":"NEGATIVE","value":360},{"name":"POSITIVE","value":318},{"name":"DESTRUCTIVE","value":28}]},{"name":"error-message","children":[{"name":"Status mismatch: Expected 409,200,201,202,210 got 400","value":360},{"name":"Response bodies did not match","value":318},{"name":"Status mismatch: Expected 400 got 500","value":28}]},{"name":"method","children":[{"name":"POST-0","value":706}]}]},{"name":"/Student/{resource:id}/v4","children":[{"name":"resource","children":[{"name":"student","value":332}]},{"name":"iteration","children":[{"name":"1 ","value":166},{"name":"2 ","value":166}]},{"name":"case","children":[{"name":"NEGATIVE","value":332}]},{"name":"error-message","children":[{"name":"Status mismatch: Expected 404,409 got 500","value":332}]},{"name":"method","children":[{"name":"DELETE-1","value":332}]}]}]},{"name":"error-message","children":[{"name":"Status mismatch: Expected 200,500 got 201","children":[{"name":"resource","children":[{"name":"student","value":360}]},{"name":"iteration","children":[{"name":"1 ","value":180},{"name":"2 ","value":180}]},{"name":"case","children":[{"name":"POSITIVE","value":360}]},{"name":"url","children":[{"name":"/Student/{resource:id}/v1","value":360}]},{"name":"method","children":[{"name":"GET-1","value":360}]}]},{"name":"Response bodies did not match","children":[{"name":"resource","children":[{"name":"student","value":1146}]},{"name":"iteration","children":[{"name":"1 ","value":573},{"name":"2 ","value":573}]},{"name":"case","children":[{"name":"POSITIVE","value":1146}]},{"name":"url","children":[{"name":"/Student/{resource:id}","value":828},{"name":"/Student","value":318}]},{"name":"method","children":[{"name":"DELETE-0","value":376},{"name":"PUT-1","value":452},{"name":"POST-0","value":318}]}]},{"name":"Status mismatch: Expected 409,200,201,202,210 got 400","children":[{"name":"resource","children":[{"name":"student","value":360}]},{"name":"iteration","children":[{"name":"1 ","value":180},{"name":"2 ","value":180}]},{"name":"case","children":[{"name":"NEGATIVE","value":360}]},{"name":"url","children":[{"name":"/Student","value":360}]},{"name":"method","children":[{"name":"POST-0","value":360}]}]},{"name":"Status mismatch: Expected 400 got 500","children":[{"name":"resource","children":[{"name":"student","value":104}]},{"name":"iteration","children":[{"name":"1 ","value":52},{"name":"2 ","value":52}]},{"name":"case","children":[{"name":"DESTRUCTIVE","value":104}]},{"name":"url","children":[{"name":"/Student/{resource:id}","value":76},{"name":"/Student","value":28}]},{"name":"method","children":[{"name":"PATCH-0","value":48},{"name":"POST-0","value":28},{"name":"POST-1","value":28}]}]},{"name":"Status mismatch: Expected 404 got 400","children":[{"name":"resource","children":[{"name":"student","value":332}]},{"name":"iteration","children":[{"name":"1 ","value":166},{"name":"2 ","value":166}]},{"name":"case","children":[{"name":"NEGATIVE","value":332}]},{"name":"url","children":[{"name":"/Student/{resource:id}","value":332}]},{"name":"method","children":[{"name":"GET-0","value":332}]}]},{"name":"Status mismatch: Expected 404,409 got 500","children":[{"name":"resource","children":[{"name":"student","value":332}]},{"name":"iteration","children":[{"name":"1 ","value":166},{"name":"2 ","value":166}]},{"name":"case","children":[{"name":"NEGATIVE","value":332}]},{"name":"url","children":[{"name":"/Student/{resource:id}/v4","value":332}]},{"name":"method","children":[{"name":"DELETE-1","value":332}]}]},{"name":"Status mismatch: Expected 201 got 200","children":[{"name":"resource","children":[{"name":"student","value":318}]},{"name":"iteration","children":[{"name":"1 ","value":159},{"name":"2 ","value":159}]},{"name":"case","children":[{"name":"POSITIVE","value":318}]},{"name":"url","children":[{"name":"/Student/{resource:id}","value":318}]},{"name":"method","children":[{"name":"POST-1","value":318}]}]},{"name":"Status mismatch: Expected 404 got 200","children":[{"name":"resource","children":[{"name":"student","value":332}]},{"name":"iteration","children":[{"name":"1 ","value":166},{"name":"2 ","value":166}]},{"name":"case","children":[{"name":"NEGATIVE","value":332}]},{"name":"url","children":[{"name":"/Student/{resource:id}","value":332}]},{"name":"method","children":[{"name":"PATCH-0","value":332}]}]}]},{"name":"method","children":[{"name":"GET-1","children":[{"name":"resource","children":[{"name":"student","value":360}]},{"name":"iteration","children":[{"name":"1 ","value":180},{"name":"2 ","value":180}]},{"name":"case","children":[{"name":"POSITIVE","value":360}]},{"name":"url","children":[{"name":"/Student/{resource:id}/v1","value":360}]},{"name":"error-message","children":[{"name":"Status mismatch: Expected 200,500 got 201","value":360}]}]},{"name":"DELETE-0","children":[{"name":"resource","children":[{"name":"student","value":376}]},{"name":"iteration","children":[{"name":"1 ","value":188},{"name":"2 ","value":188}]},{"name":"case","children":[{"name":"POSITIVE","value":376}]},{"name":"url","children":[{"name":"/Student/{resource:id}","value":376}]},{"name":"error-message","children":[{"name":"Response bodies did not match","value":376}]}]},{"name":"POST-0","children":[{"name":"resource","children":[{"name":"student","value":706}]},{"name":"iteration","children":[{"name":"1 ","value":353},{"name":"2 ","value":353}]},{"name":"case","children":[{"name":"NEGATIVE","value":360},{"name":"POSITIVE","value":318},{"name":"DESTRUCTIVE","value":28}]},{"name":"url","children":[{"name":"/Student","value":706}]},{"name":"error-message","children":[{"name":"Status mismatch: Expected 409,200,201,202,210 got 400","value":360},{"name":"Response bodies did not match","value":318},{"name":"Status mismatch: Expected 400 got 500","value":28}]}]},{"name":"PATCH-0","children":[{"name":"resource","children":[{"name":"student","value":380}]},{"name":"iteration","children":[{"name":"1 ","value":190},{"name":"2 ","value":190}]},{"name":"case","children":[{"name":"DESTRUCTIVE","value":48},{"name":"NEGATIVE","value":332}]},{"name":"url","children":[{"name":"/Student/{resource:id}","value":380}]},{"name":"error-message","children":[{"name":"Status mismatch: Expected 400 got 500","value":48},{"name":"Status mismatch: Expected 404 got 200","value":332}]}]},{"name":"PUT-1","children":[{"name":"resource","children":[{"name":"student","value":452}]},{"name":"iteration","children":[{"name":"1 ","value":226},{"name":"2 ","value":226}]},{"name":"case","children":[{"name":"POSITIVE","value":452}]},{"name":"url","children":[{"name":"/Student/{resource:id}","value":452}]},{"name":"error-message","children":[{"name":"Response bodies did not match","value":452}]}]},{"name":"GET-0","children":[{"name":"resource","children":[{"name":"student","value":332}]},{"name":"iteration","children":[{"name":"1 ","value":166},{"name":"2 ","value":166}]},{"name":"case","children":[{"name":"NEGATIVE","value":332}]},{"name":"url","children":[{"name":"/Student/{resource:id}","value":332}]},{"name":"error-message","children":[{"name":"Status mismatch: Expected 404 got 400","value":332}]}]},{"name":"DELETE-1","children":[{"name":"resource","children":[{"name":"student","value":332}]},{"name":"iteration","children":[{"name":"1 ","value":166},{"name":"2 ","value":166}]},{"name":"case","children":[{"name":"NEGATIVE","value":332}]},{"name":"url","children":[{"name":"/Student/{resource:id}/v4","value":332}]},{"name":"error-message","children":[{"name":"Status mismatch: Expected 404,409 got 500","value":332}]}]},{"name":"POST-1","children":[{"name":"resource","children":[{"name":"student","value":346}]},{"name":"iteration","children":[{"name":"1 ","value":173},{"name":"2 ","value":173}]},{"name":"case","children":[{"name":"POSITIVE","value":318},{"name":"DESTRUCTIVE","value":28}]},{"name":"url","children":[{"name":"/Student/{resource:id}","value":346}]},{"name":"error-message","children":[{"name":"Status mismatch: Expected 201 got 200","value":318},{"name":"Status mismatch: Expected 400 got 500","value":28}]}]}]}]}`);
        </script>
        <!-- Donut at the top -->
        <script>
            function makePieChart() {
                // set the dimensions and margins of the graph
                var width = 300;
                height = 300;

                // The radius of the pieplot is half the width or half the height (smallest one). I subtract a bit of margin.
                var radius = Math.min(width, height) / 2;

                // append the svg object to the div called 'summary-donut'
                var svg = d3
                    .select("#summary-donut")
                    .insert("svg", "#donut-label")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("id", "donut-svg")
                    .append("g")
                    .attr(
                        "transform",
                        "translate(" + width / 2 + "," + height / 2 + ")"
                    );

                // Create dummy data

                var pieData = { Passed: data.passed, Failed: data.failed };
                // set the color scale
                var color = d3
                    .scaleOrdinal()
                    .domain(pieData)
                    .range(["#16a849", "#eb0909"]);

                // Compute the position of each group on the pie:
                var pie = d3.pie().value(function (d) {
                    return d.value;
                });
                var data_ready = pie(d3.entries(pieData));

                // The arc generator
                var arc = d3
                    .arc()
                    .innerRadius(radius * 0.4) // This is the size of the donut hole
                    .outerRadius(radius * 0.8);

                // Another arc that won't be drawn. Just for labels positioning
                var outerArc = d3
                    .arc()
                    .innerRadius(radius * 0.9)
                    .outerRadius(radius * 0.9);

                // Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
                svg.selectAll("whatever")
                    .data(data_ready)
                    .enter()
                    .append("path")
                    .attr("d", arc)
                    .attr("fill", function (d) {
                        return color(d.data.key);
                    })
                    .attr("stroke", "white")
                    .style("stroke-width", 5)
                    .style("opacity", 0.7);

                // Add the polylines between chart and labels:
                svg.selectAll("allPolylines")
                    .data(data_ready)
                    .enter()
                    .append("polyline")
                    .attr("stroke", "grey")
                    .style("fill", "none")
                    .attr("stroke-width", 2)
                    .attr("points", function (d) {
                        var posA = arc.centroid(d); // line insertion in the slice
                        var posB = outerArc.centroid(d); // line break: we use the other arc generator that has been built only for that
                        var posC = outerArc.centroid(d); // Label position = almost the same as posB
                        var midangle =
                            d.startAngle + (d.endAngle - d.startAngle) / 2; // we need the angle to see if the X position will be at the extreme right or extreme left
                        posC[0] = radius * 0.95 * (midangle < Math.PI ? 1 : -1); // multiply by 1 or -1 to put it on the right or on the left
                        return [posA, posB, posC];
                    });

                // // Add the polylines between chart and labels:
                svg.selectAll("allLabels")
                    .data(data_ready)
                    .enter()
                    .append("text")
                    .text(function (d) {
                        return d.data.key + ": " + d.data.value;
                    })
                    .attr("transform", function (d) {
                        var pos = outerArc.centroid(d);
                        var midangle =
                            d.startAngle + (d.endAngle - d.startAngle) / 2;
                        pos[0] = radius * 0.99 * (midangle < Math.PI ? 1 : -1);
                        return "translate(" + pos + ")";
                    })
                    .style("text-anchor", function (d) {
                        var midangle =
                            d.startAngle + (d.endAngle - d.startAngle) / 2;
                        return midangle < Math.PI ? "start" : "end";
                    });

                d3.select("#donut-label").html("Total tests: " + data.total);
            }
            makePieChart();
        </script>
        <!-- Heirarchial bar graph -->
        <script>
            function makeBarGraph() {
                var barData = {
                    name: "parsed-results",
                    children: data.parsedAssertions,
                };
                var root = d3
                    .hierarchy(barData)
                    .sort(function (a, b) {
                        return b.value - a.value;
                    })
                    .eachAfter(function (d) {
                        d.index = d.parent
                            ? (d.parent.index = d.parent.index + 1 || 0)
                            : 0;
                        if (d.data.value) d.value = d.data.value;
                        else if (d.height === 1) {
                            d.value = d.children.reduce(function (prev, child) {
                                return prev + child.value;
                            }, 0);
                        } else if (d.height === 2)
                            d.value = d.children[0] ? d.children[0].value : 0;
                        else if (d.height === 3)
                            d.value = d.children.reduce(function (prev, child) {
                                return prev + child.value;
                            }, 0);
                        else d.value = data.failed;
                    });

                var margin = { top: 30, right: 0, bottom: 0, left: 0 },
                    width = 700 - margin.left - margin.right,
                    barStep = 27,
                    barPadding = 3 / barStep,
                    duration = 300;

                var max = 1;
                root.each(
                    (d) =>
                        d.children && (max = Math.max(max, d.children.length))
                );
                var height = max * barStep + margin.top + margin.bottom;

                color = d3.scaleOrdinal([true, false], ["#78a8e3", "#aaa"]);
                x = d3
                    .scaleLinear()
                    .domain(0, data.totalFailed)
                    .range([margin.left, width - margin.right]);
                yAxis = function (g) {
                    return g
                        .attr("class", "y-axis")
                        .attr("transform", `translate(${margin.left + 0.5},0)`)
                        .call((g) =>
                            g
                                .append("line")
                                .attr("stroke", "currentColor")
                                .attr("y1", margin.top)
                                .attr("y2", height - margin.bottom)
                        );
                };

                xAxis = function (g) {
                    g.attr("class", "x-axis")
                        .attr("transform", `translate(0,${margin.top})`)
                        .call(d3.axisTop(x))
                        .call((g) =>
                            (g.selection ? g.selection() : g)
                                .select(".domain")
                                .remove()
                        );
                };

                function stagger() {
                    let value = 0;
                    return (d, i) => {
                        const t = `translate(${x(value) - x(0)},${
                            barStep * i
                        })`;
                        value += d.value;
                        return t;
                    };
                }

                function stack(i) {
                    let value = 0;
                    return (d) => {
                        const t = `translate(${x(value) - x(0)},${
                            barStep * i
                        })`;
                        value += d.value;
                        return t;
                    };
                }

                function up(svg, d) {
                    if (!d.parent || !svg.selectAll(".exit").empty()) return;

                    // Rebind the current node to the background.
                    svg.select(".background").datum(d.parent);

                    // Define two sequenced transitions.
                    const transition1 = svg.transition().duration(duration);
                    const transition2 = transition1.transition();

                    // Mark any currently-displayed bars as exiting.
                    const exit = svg.selectAll(".enter").attr("class", "exit");

                    // Update the x-scale domain.
                    x.domain([0, d3.max(d.parent.children, (d) => d.value)]);

                    // Update the x-axis.
                    svg.selectAll(".x-axis")
                        .transition(transition1)
                        .call(xAxis);

                    // Transition exiting bars to the new x-scale.
                    exit.selectAll("g")
                        .transition(transition1)
                        .attr("transform", stagger());

                    // Transition exiting bars to the parentâ€™s position.
                    exit.selectAll("g")
                        .transition(transition2)
                        .attr("transform", stack(d.index));

                    // Transition exiting rects to the new scale and fade to parent color.
                    exit.selectAll("rect")
                        .transition(transition1)
                        .attr("width", (d) => x(d.value) - x(0))
                        .attr("fill", color(true));

                    // Transition exiting text to fade out.
                    // Remove exiting nodes.
                    exit.transition(transition2)
                        .attr("fill-opacity", 0)
                        .remove();

                    // Enter the new bars for the clicked-on data's parent.
                    const enter = bar(svg, down, d.parent, ".exit").attr(
                        "fill-opacity",
                        0
                    );

                    enter
                        .selectAll("g")
                        .attr(
                            "transform",
                            (d, i) => `translate(0,${barStep * i})`
                        );

                    // Transition entering bars to fade in over the full duration.
                    enter.transition(transition2).attr("fill-opacity", 1);

                    // Color the bars as appropriate.
                    // Exiting nodes will obscure the parent bar, so hide it.
                    // Transition entering rects to the new x-scale.
                    // When the entering parent rect is done, make it visible!
                    enter
                        .selectAll("rect")
                        .attr("fill", (d) => color(!!d.children))
                        .attr("fill-opacity", (p) => (p === d ? 0 : null))
                        .transition(transition2)
                        .attr("width", (d) => x(d.value) - x(0))
                        .on("end", function (p) {
                            d3.select(this).attr("fill-opacity", 1);
                        });
                }

                function down(svg, d) {
                    if (!d.children || d3.active(svg.node())) return;

                    // Rebind the current node to the background.
                    svg.select(".background").datum(d);

                    // Define two sequenced transitions.
                    const transition1 = svg.transition().duration(duration);
                    const transition2 = transition1.transition();

                    // Mark any currently-displayed bars as exiting.
                    const exit = svg.selectAll(".enter").attr("class", "exit");

                    // Entering nodes immediately obscure the clicked-on bar, so hide it.
                    exit.selectAll("rect").attr("fill-opacity", (p) =>
                        p === d ? 0 : null
                    );

                    // Transition exiting bars to fade out.
                    exit.transition(transition1)
                        .attr("fill-opacity", 0)
                        .remove();

                    // Enter the new bars for the clicked-on data.
                    // Per above, entering bars are immediately visible.
                    const enter = bar(svg, down, d, ".y-axis").attr(
                        "fill-opacity",
                        0
                    );

                    // Have the text fade-in, even though the bars are visible.
                    enter.transition(transition1).attr("fill-opacity", 1);

                    // Transition entering bars to their new y-position.
                    enter
                        .selectAll("g")
                        .attr("transform", stack(d.index))
                        .transition(transition1)
                        .attr("transform", stagger());

                    // Update the x-scale domain.
                    x.domain([0, d3.max(d.children, (d) => d.value)]);

                    // Update the x-axis.
                    svg.selectAll(".x-axis")
                        .transition(transition2)
                        .call(xAxis);

                    // Transition entering bars to the new x-scale.
                    enter
                        .selectAll("g")
                        .transition(transition2)
                        .attr(
                            "transform",
                            (d, i) => `translate(0,${barStep * i})`
                        );

                    // Color the bars as parents; they will fade to children if appropriate.
                    enter
                        .selectAll("rect")
                        .attr("fill", color(true))
                        .attr("fill-opacity", 1)
                        .transition(transition2)
                        .attr("fill", (d) => color(!!d.children))
                        .attr("width", (d) => x(d.value) - x(0));
                }

                // Creates a set of bars for the given data node, at the specified index.
                function bar(svg, down, d, selector) {
                    const g = svg
                        .insert("g", selector)
                        .attr("class", "enter")
                        .attr(
                            "transform",
                            `translate(0,${margin.top + barStep * barPadding})`
                        )
                        .attr("text-anchor", "end")
                        .style("font", "10px sans-serif");

                    const bar = g
                        .selectAll("g")
                        .data(d.children)
                        .join("g")
                        .attr("cursor", (d) => (!d.children ? null : "pointer"))
                        .on("click", (d) => down(svg, d));

                    bar.append("text")
                        .attr("x", margin.left - 6)
                        .attr("y", (barStep * (1 - barPadding)) / 2)
                        .attr("dy", ".35em")
                        .text((d) => d.data.name);

                    bar.append("rect")
                        .attr("x", x(0))
                        .attr("width", (d) => x(d.value) - x(0))
                        .attr("height", barStep * (1 - barPadding));

                    bar.append("text")
                        .attr("x", (d) => x(d.value) - x(0))
                        .attr("y", (barStep * (1 - barPadding)) / 2)
                        .attr("dy", ".35em")
                        .attr("id", "error-bar-label")
                        .text((d) => d.value);

                    return g;
                }

                const svg = d3
                    .select("#error-bar-chart")
                    .insert("svg", "#error-caption")
                    .attr("id", "error-svg")
                    .attr("width", width)
                    .attr("height", height);

                x.domain([0, root.value]);

                svg.append("rect")
                    .attr("class", "background")
                    .attr("fill", "none")
                    .attr("pointer-events", "all")
                    .attr("width", width)
                    .attr("height", height)
                    .attr("cursor", "pointer")
                    .on("click", (d) => up(svg, d));

                svg.append("g").call(xAxis);

                svg.append("g").call(yAxis);

                down(svg, root);

                svg.node();
            }
            makeBarGraph();
        </script>
    </body>
</html>
